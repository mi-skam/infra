@startuml terraform_provisioning_with_secrets
title Terraform Provisioning with Secrets Workflow

actor Operator
participant "Just Recipe" as Just
participant SOPS
participant "Age Key\n(~/.config/sops/age/keys.txt)" as Age
participant "OpenTofu CLI" as Tofu
participant "Hetzner Cloud API" as HetznerAPI

Operator -> Just: just tf-plan
activate Just

note over Just
  Recipe contains:
  export TF_VAR_hcloud_token="$(sops -d ../secrets/hetzner.yaml | grep 'hcloud:' | cut -d: -f2 | xargs)"
end note

Just -> SOPS: sops -d ../secrets/hetzner.yaml
activate SOPS

SOPS -> Age: Check age key exists at\n~/.config/sops/age/keys.txt

alt Age key present
    Age --> SOPS: Key found
    SOPS -> SOPS: Decrypt secrets/hetzner.yaml using age key

    note over SOPS
      Decrypted content:
      hetzner:
        hcloud: "abc123token456xyz"
    end note

    SOPS --> Just: Decrypted YAML content
    deactivate SOPS

    Just -> Just: Extract token:\ngrep 'hcloud:' | cut -d: -f2 | xargs
    Just -> Just: export TF_VAR_hcloud_token="abc123token456xyz"

    note over Just
      Environment variable set:
      TF_VAR_hcloud_token="abc123token456xyz"
    end note

    Just -> Tofu: cd terraform && tofu plan
    activate Tofu

    Tofu -> Tofu: Read TF_VAR_hcloud_token from environment
    Tofu -> Tofu: Initialize Hetzner provider with token

    Tofu -> HetznerAPI: API request with authentication\nGET /servers, /networks, etc.
    activate HetznerAPI

    HetznerAPI -> HetznerAPI: Validate token
    HetznerAPI --> Tofu: Infrastructure state data
    deactivate HetznerAPI

    Tofu -> Tofu: Compare current state with desired state
    Tofu --> Just: Plan output (changes to apply)
    deactivate Tofu

    Just --> Operator: Display plan:\n+ Resources to create\n~ Resources to modify\n- Resources to destroy

else Age key missing
    Age --> SOPS: Error: Key not found
    SOPS --> Just: Decryption failed (empty output)
    deactivate SOPS

    Just -> Just: export TF_VAR_hcloud_token="" (empty)

    Just -> Tofu: cd terraform && tofu plan
    activate Tofu

    Tofu -> Tofu: Read TF_VAR_hcloud_token (empty/undefined)
    Tofu --> Just: ERROR: Missing required variable 'hcloud_token'
    deactivate Tofu

    Just --> Operator: ERROR: Cannot proceed without Hetzner API token\n\nEnsure age key exists at:\n~/.config/sops/age/keys.txt
    deactivate Just
end

note over SOPS, Tofu
  **Security Pattern**:
  - Secret never written to disk in plaintext
  - Token passed via environment variable
  - Token only exists in process memory
  - Same pattern used in 8 different just recipes
end note

note over HetznerAPI
  Alternative just recipes using same pattern:
  - tf-apply (provision infrastructure)
  - tf-destroy (teardown resources)
  - tf-import (import existing resources)
  - tf-output (show outputs)
  - ansible-inventory-update (sync inventory)
end note

@enduml
