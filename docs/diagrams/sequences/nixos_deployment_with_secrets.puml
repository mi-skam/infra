@startuml nixos_deployment_with_secrets
title NixOS Deployment with Secrets Workflow

actor Operator
participant "nixos-rebuild" as Rebuild
participant "Nix Evaluator" as Nix
participant "sops-nix Module" as SopsNix
participant SOPS
participant "Age Key\n(/etc/sops/age/keys.txt)" as Age
participant "System Activation" as System
participant "System Services" as Services

Operator -> Rebuild: sudo nixos-rebuild switch --flake .#xmsi
activate Rebuild

Rebuild -> Nix: Evaluate flake configuration
activate Nix

Nix -> Nix: Load NixOS modules
Nix -> SopsNix: Process secrets configuration
activate SopsNix

SopsNix -> SOPS: Request secret decryption
activate SOPS

SOPS -> Age: Check age key exists at /etc/sops/age/keys.txt

alt Age key present
    Age --> SOPS: Key found (600 permissions, root:root)
    SOPS -> SOPS: Decrypt secrets using age key
    SOPS --> SopsNix: Decrypted secrets data
    SopsNix -> SopsNix: Mount secrets at runtime paths\n(/run/secrets/*)
    SopsNix --> Nix: Secrets configured
    deactivate SopsNix
    deactivate SOPS

    Nix -> Nix: Build system configuration
    Nix --> Rebuild: Configuration built successfully
    deactivate Nix

    Rebuild -> System: Activate new configuration
    activate System

    System -> System: Switch system profile
    System -> Services: Start/restart services
    activate Services

    Services -> Services: Access secrets from /run/secrets/*
    Services --> System: Services running
    deactivate Services

    System --> Rebuild: Activation complete
    deactivate System

    Rebuild --> Operator: Deployment successful

else Age key missing or invalid
    Age --> SOPS: Error: Key not found or wrong permissions
    SOPS --> SopsNix: Decryption failed
    deactivate SOPS
    SopsNix --> Nix: Error: Cannot decrypt secrets
    deactivate SopsNix
    Nix --> Rebuild: Build failed
    deactivate Nix
    Rebuild --> Operator: ERROR: No valid decryption key found\n\nManual fix required:\nsudo mkdir -p /etc/sops/age\nsudo cp age-private-key.txt /etc/sops/age/keys.txt\nsudo chmod 600 /etc/sops/age/keys.txt\nsudo chown root:root /etc/sops/age/keys.txt
    deactivate Rebuild
end

note over Age
  **CRITICAL**: Age private key must be
  manually deployed before first NixOS
  rebuild. Never stored in repository.
end note

note over SopsNix, Services
  Secrets are decrypted during Nix evaluation
  and mounted at /run/secrets/* for runtime access.
  Only root and configured service users can read them.
end note

@enduml
