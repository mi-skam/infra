graph TD
    %% ============================================================================
    %% Justfile Recipe Dependency Graph
    %% ============================================================================
    %% Generated: 2025-10-28
    %% Source: justfile (230 lines, 27 recipes)
    %% Purpose: Visualize recipe dependencies and tool invocations
    %% ============================================================================

    %% User entry points
    User([User/Operator])

    %% ============================================================================
    %% Recipe Nodes
    %% ============================================================================

    %% Utility
    default[default<br/>List recipes]

    %% Terraform/OpenTofu recipes
    tf-init[tf-init<br/>Initialize Terraform]
    tf-plan[tf-plan<br/>Plan changes]
    tf-apply[tf-apply<br/>Apply changes]
    tf-destroy[tf-destroy<br/>Destroy infrastructure]
    tf-destroy-target[tf-destroy-target<br/>Destroy specific resource]
    tf-import[tf-import<br/>Import resources]
    tf-output[tf-output<br/>Show outputs]
    ansible-inventory-update[ansible-inventory-update<br/>Export to Ansible]

    %% Ansible recipes
    ansible-ping[ansible-ping<br/>Test connectivity]
    ansible-deploy[ansible-deploy<br/>Run playbook on all]
    ansible-deploy-to[ansible-deploy-to<br/>Run playbook on env]
    ansible-inventory[ansible-inventory<br/>List inventory]
    ansible-cmd[ansible-cmd<br/>Ad-hoc command]
    ssh[ssh<br/>SSH to server]

    %% Dotfiles recipes
    install-all[install-all<br/>Install everything]
    install-brew[install-brew<br/>Install Homebrew packages]
    install-dotfiles[install-dotfiles<br/>Stow all dotfiles]
    uninstall-dotfiles[uninstall-dotfiles<br/>Unstow all dotfiles]
    ensure-stow[ensure-stow<br/>Ensure stow installed]
    dry-run[dry-run<br/>Simulate stow]
    install[install<br/>Stow specific package]
    uninstall[uninstall<br/>Unstow specific package]
    restow[restow<br/>Re-stow packages]
    check[check<br/>Check conflicts]
    clean[clean<br/>Find broken symlinks]
    test-install[test-install<br/>Test in temp dir]

    %% ============================================================================
    %% External Tools
    %% ============================================================================

    sops{{SOPS<br/>Secrets decryption}}
    tofu{{OpenTofu<br/>Infrastructure}}
    ansible{{Ansible<br/>Configuration}}
    stow{{GNU Stow<br/>Symlink manager}}
    brew{{Homebrew<br/>Package manager}}
    jq{{jq<br/>JSON processor}}
    ssh-tool{{SSH<br/>Remote shell}}

    %% ============================================================================
    %% Data Dependencies
    %% ============================================================================

    age-key[(SOPS age key<br/>~/.config/sops/age/keys.txt)]
    hetzner-secrets[(secrets/hetzner.yaml<br/>Hetzner API token)]
    tf-state[(terraform.tfstate<br/>Infrastructure state)]
    ansible-inv[(hosts.yaml<br/>Ansible inventory)]
    ssh-key[(~/.ssh/homelab/hetzner<br/>SSH private key)]
    dotfiles-dir[(dotfiles/<br/>Dotfile packages)]
    brewfile[(dotfiles/brew/.Brewfile<br/>Homebrew packages)]

    %% ============================================================================
    %% User Interactions
    %% ============================================================================

    User --> default
    User --> tf-init
    User --> tf-plan
    User --> tf-apply
    User --> tf-destroy
    User --> tf-destroy-target
    User --> tf-import
    User --> tf-output
    User --> ansible-inventory-update
    User --> ansible-ping
    User --> ansible-deploy
    User --> ansible-deploy-to
    User --> ansible-inventory
    User --> ansible-cmd
    User --> ssh
    User --> install-all
    User --> dry-run
    User --> install
    User --> uninstall
    User --> restow
    User --> check
    User --> clean
    User --> test-install

    %% ============================================================================
    %% Explicit Recipe Dependencies (Declared in justfile)
    %% ============================================================================

    install-all --> install-brew
    install-all --> install-dotfiles
    install-dotfiles --> ensure-stow

    %% ============================================================================
    %% Implicit Recipe Dependencies (Should exist but not declared)
    %% ============================================================================

    tf-plan -.->|should depend on| tf-init
    tf-apply -.->|should depend on| tf-init
    tf-destroy -.->|should depend on| tf-init
    tf-destroy-target -.->|should depend on| tf-init
    tf-import -.->|should depend on| tf-init
    tf-output -.->|should depend on| tf-init
    ansible-inventory-update -.->|should depend on| tf-init

    ansible-deploy -.->|should use| ansible-inventory-update
    ansible-deploy-to -.->|should use| ansible-inventory-update
    ansible-ping -.->|should verify| ansible-inventory-update

    %% ============================================================================
    %% Tool Invocations
    %% ============================================================================

    %% Terraform recipes call SOPS (8 times - DUPLICATION!)
    tf-plan --> sops
    tf-apply --> sops
    tf-destroy --> sops
    tf-destroy-target --> sops
    tf-import --> sops
    tf-output --> sops
    ansible-inventory-update --> sops
    ssh --> sops

    %% Terraform recipes call tofu
    tf-init --> tofu
    tf-plan --> tofu
    tf-apply --> tofu
    tf-destroy --> tofu
    tf-destroy-target --> tofu
    tf-import --> tofu
    tf-output --> tofu
    ansible-inventory-update --> tofu

    %% SSH recipe calls jq and ssh
    ssh --> jq
    ssh --> ssh-tool

    %% Ansible recipes call ansible
    ansible-ping --> ansible
    ansible-deploy --> ansible
    ansible-deploy-to --> ansible
    ansible-inventory --> ansible
    ansible-cmd --> ansible

    %% Dotfiles recipes call stow
    install-dotfiles --> stow
    uninstall-dotfiles --> stow
    dry-run --> stow
    install --> stow
    uninstall --> stow
    restow --> stow
    check --> stow

    %% Brew installation
    install-brew --> brew
    ensure-stow --> brew

    %% ============================================================================
    %% Data Dependencies
    %% ============================================================================

    %% SOPS requires age key
    sops -.->|requires| age-key
    sops -.->|decrypts| hetzner-secrets

    %% Terraform recipes require state
    tf-plan -.->|reads| tf-state
    tf-apply -.->|modifies| tf-state
    tf-destroy -.->|modifies| tf-state
    tf-destroy-target -.->|modifies| tf-state
    tf-import -.->|modifies| tf-state
    tf-output -.->|reads| tf-state
    ansible-inventory-update -.->|reads| tf-state
    ssh -.->|reads| tf-state

    %% Ansible inventory dependency
    ansible-inventory-update -.->|writes| ansible-inv
    ansible-ping -.->|reads| ansible-inv
    ansible-deploy -.->|reads| ansible-inv
    ansible-deploy-to -.->|reads| ansible-inv
    ansible-inventory -.->|reads| ansible-inv
    ansible-cmd -.->|reads| ansible-inv

    %% SSH key dependency
    ssh -.->|requires| ssh-key

    %% Dotfiles dependencies
    install-brew -.->|reads| brewfile
    install-dotfiles -.->|reads| dotfiles-dir
    uninstall-dotfiles -.->|reads| dotfiles-dir
    dry-run -.->|reads| dotfiles-dir
    install -.->|reads| dotfiles-dir
    uninstall -.->|reads| dotfiles-dir
    restow -.->|reads| dotfiles-dir
    check -.->|reads| dotfiles-dir
    test-install -.->|reads| dotfiles-dir

    %% ============================================================================
    %% Subgraph Grouping by Category
    %% ============================================================================

    subgraph terraform_recipes["Terraform/OpenTofu Operations (9 recipes)"]
        tf-init
        tf-plan
        tf-apply
        tf-destroy
        tf-destroy-target
        tf-import
        tf-output
        ansible-inventory-update
    end

    subgraph ansible_recipes["Ansible Configuration Management (6 recipes)"]
        ansible-ping
        ansible-deploy
        ansible-deploy-to
        ansible-inventory
        ansible-cmd
        ssh
    end

    subgraph dotfiles_recipes["Dotfiles Management (11 recipes)"]
        install-all
        install-brew
        install-dotfiles
        uninstall-dotfiles
        ensure-stow
        dry-run
        install
        uninstall
        restow
        check
        clean
        test-install
    end

    subgraph utility_recipes["Utility (1 recipe)"]
        default
    end

    subgraph external_tools["External Tools"]
        sops
        tofu
        ansible
        stow
        brew
        jq
        ssh-tool
    end

    subgraph data_files["Data Dependencies"]
        age-key
        hetzner-secrets
        tf-state
        ansible-inv
        ssh-key
        dotfiles-dir
        brewfile
    end

    %% ============================================================================
    %% Styling
    %% ============================================================================

    classDef terraform fill:#e1f5ff,stroke:#01579b,stroke-width:2px
    classDef ansible fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef dotfiles fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef utility fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px
    classDef tool fill:#fff9c4,stroke:#f57f17,stroke-width:2px
    classDef data fill:#fce4ec,stroke:#880e4f,stroke-width:2px
    classDef user fill:#e0f2f1,stroke:#004d40,stroke-width:3px

    class tf-init,tf-plan,tf-apply,tf-destroy,tf-destroy-target,tf-import,tf-output,ansible-inventory-update terraform
    class ansible-ping,ansible-deploy,ansible-deploy-to,ansible-inventory,ansible-cmd,ssh ansible
    class install-all,install-brew,install-dotfiles,uninstall-dotfiles,ensure-stow,dry-run,install,uninstall,restow,check,clean,test-install dotfiles
    class default utility
    class sops,tofu,ansible,stow,brew,jq,ssh-tool tool
    class age-key,hetzner-secrets,tf-state,ansible-inv,ssh-key,dotfiles-dir,brewfile data
    class User user

    %% ============================================================================
    %% Legend
    %% ============================================================================

    subgraph legend["Legend"]
        direction LR
        L1[Solid line: Actual dependency/call]
        L2[Dashed line: Implicit/data dependency]
        L3{{Tool invocation}}
        L4[(Data file/resource)]
    end

    %% ============================================================================
    %% Critical Findings Highlighted
    %% ============================================================================

    %% FINDING 1: SOPS called 8 times (duplication!)
    %% Lines: 25, 32, 39, 48, 55, 62, 69, 101
    %% Recommendation: Extract to shared helper recipe

    %% FINDING 2: No validation recipes
    %% Missing: _validate-age-key, _validate-terraform-state, _validate-ansible-inventory

    %% FINDING 3: Implicit dependencies not enforced
    %% All tf-* recipes should depend on tf-init
    %% All ansible-* recipes should verify inventory freshness

    %% FINDING 4: Dotfiles recipes are separate concern
    %% 11 recipes (48% of total) unrelated to infrastructure
    %% Recommendation: Move to separate dotfiles.justfile
