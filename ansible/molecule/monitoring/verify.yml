---
- name: Verify monitoring role
  hosts: all
  become: true
  tasks:
    # node_exporter verification
    - name: Check node_exporter binary exists
      stat:
        path: /usr/local/bin/node_exporter
      register: node_exporter_binary
      failed_when: not node_exporter_binary.stat.exists or not node_exporter_binary.stat.executable

    - name: Check node_exporter systemd service file exists
      stat:
        path: /etc/systemd/system/node_exporter.service
      register: node_exporter_service
      failed_when: not node_exporter_service.stat.exists

    - name: Verify node_exporter service is enabled
      systemd:
        name: node_exporter
        enabled: true
      check_mode: yes
      register: node_exporter_service_check
      failed_when: node_exporter_service_check.changed

    # Promtail verification
    - name: Check promtail binary exists
      stat:
        path: /usr/local/bin/promtail
      register: promtail_binary
      failed_when: not promtail_binary.stat.exists or not promtail_binary.stat.executable

    - name: Check promtail config directory exists
      stat:
        path: /etc/promtail
      register: promtail_config_dir
      failed_when: not promtail_config_dir.stat.exists

    - name: Check promtail config file exists
      stat:
        path: /etc/promtail/promtail.yaml
      register: promtail_config
      failed_when: not promtail_config.stat.exists

    - name: Check promtail systemd service file exists
      stat:
        path: /etc/systemd/system/promtail.service
      register: promtail_service
      failed_when: not promtail_service.stat.exists

    - name: Verify promtail service is enabled
      systemd:
        name: promtail
        enabled: true
      check_mode: yes
      register: promtail_service_check
      failed_when: promtail_service_check.changed
